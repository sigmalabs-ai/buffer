<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Buffer Dashboard</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=DM+Sans:wght@400;500;600&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', -apple-system, system-ui, sans-serif;
    background: #09090b;
    color: #d4d4d8;
    padding: 24px;
    min-height: 100vh;
  }

  .layout {
    display: grid;
    grid-template-columns: 340px 1fr;
    gap: 32px;
    align-items: start;
    padding: 0 8px;
  }
  @media (max-width: 768px) {
    .layout { grid-template-columns: 1fr; }
  }
  .col { display: flex; flex-direction: column; gap: 16px; }

  .card {
    background: transparent;
    border: none;
    border-radius: 0;
    padding: 0;
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }

  .card-title {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: #52525b;
  }

  .mono {
    font-family: 'JetBrains Mono', monospace;
  }

  /* ‚îÄ‚îÄ Left: Session Feed ‚îÄ‚îÄ */
  .feed { display: flex; flex-direction: column; gap: 16px; }

  .focus-block {
    font-size: 16px;
    font-weight: 500;
    color: #e4e4e7;
    line-height: 1.5;
    padding: 14px 16px;
    background: #18181b;
    border-radius: 10px;
    border-left: 3px solid #52525b;
  }

  .feed-section { margin-top: 4px; }

  .feed-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-top: 8px;
  }

  .feed-item {
    font-size: 13px;
    color: #a1a1aa;
    padding: 8px 12px 8px 14px;
    background: #18181b;
    border-radius: 8px;
    line-height: 1.45;
    position: relative;
  }
  .feed-item::before {
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 3px;
    border-radius: 3px 0 0 3px;
    content: '';
  }
  .feed-item.topic::before { background: #3f3f46; }
  .feed-item.decision::before { background: #eab308; }
  .feed-item.outcome::before { background: #22c55e; }

  .feed-footer {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: #27272a;
    margin-top: 8px;
  }

  /* ‚îÄ‚îÄ Right: Metrics ‚îÄ‚îÄ */
  .metrics { display: flex; flex-direction: column; gap: 12px; }

  /* Context */
  .zone-badge {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.5px;
  }
  .zone-badge.green { background: rgba(34,197,94,0.12); color: #22c55e; }
  .zone-badge.yellow { background: rgba(234,179,8,0.12); color: #eab308; }
  .zone-badge.orange { background: rgba(249,115,22,0.12); color: #f97316; }
  .zone-badge.red { background: rgba(239,68,68,0.12); color: #ef4444; }

  .big-pct {
    font-family: 'JetBrains Mono', monospace;
    font-size: 44px;
    font-weight: 700;
    letter-spacing: -2px;
    line-height: 1;
    margin-bottom: 4px;
    transition: color 0.6s ease;
  }
  .big-pct.green { color: #22c55e; }
  .big-pct.yellow { color: #eab308; }
  .big-pct.orange { color: #f97316; }
  .big-pct.red { color: #ef4444; }

  .context-sub {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: #52525b;
    margin-bottom: 16px;
  }

  .bar-track {
    position: relative;
    height: 16px;
    background: #18181b;
    border-radius: 8px;
    overflow: visible;
    margin-bottom: 6px;
  }

  .bar-fill {
    height: 100%;
    border-radius: 8px;
    transition: width 1s cubic-bezier(0.22, 1, 0.36, 1), background 0.6s ease;
    min-width: 3px;
  }
  .bar-fill.green { background: linear-gradient(90deg, #16a34a, #22c55e); }
  .bar-fill.yellow { background: linear-gradient(90deg, #ca8a04, #eab308); }
  .bar-fill.orange { background: linear-gradient(90deg, #ea580c, #f97316); }
  .bar-fill.red { background: linear-gradient(90deg, #dc2626, #ef4444); }

  .zone-markers {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    pointer-events: none;
  }
  .zone-mark {
    position: absolute;
    top: -3px; bottom: -3px;
    width: 1px;
    background: #27272a;
  }
  .zone-mark-label {
    position: absolute;
    top: -15px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px;
    color: #3f3f46;
    transform: translateX(-50%);
  }

  .zone-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
  }
  .zone-legend-item {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 10px;
    color: #3f3f46;
  }
  .zone-dot {
    width: 5px; height: 5px;
    border-radius: 50%;
  }
  .zone-dot.green { background: #22c55e; }
  .zone-dot.yellow { background: #eab308; }
  .zone-dot.orange { background: #f97316; }
  .zone-dot.red { background: #ef4444; }

  /* Session meta row in metrics */
  .meta-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
  }
  .meta-label { font-size: 11px; color: #52525b; }
  .meta-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: #a1a1aa;
  }

  /* Boot */
  .boot-grid {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .boot-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 8px;
    background: #18181b;
    border-radius: 5px;
    font-size: 11px;
  }
  .boot-name { color: #71717a; }
  .boot-size { font-family: 'JetBrains Mono', monospace; font-size: 11px; }
  .boot-size.ok { color: #22c55e; }
  .boot-size.over { color: #ef4444; }

  .boot-totals {
    display: flex;
    justify-content: space-between;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid #1e1e22;
  }
  .boot-total-item { text-align: center; }
  .boot-total-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    font-weight: 600;
    color: #a1a1aa;
  }
  .boot-total-label {
    font-size: 9px;
    color: #3f3f46;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 2px;
  }

  /* Footer */
  .footer {
    margin: 12px auto 0;
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: #27272a;
    text-align: center;
  }
  .pulse {
    display: inline-block;
    width: 6px; height: 6px;
    border-radius: 50%;
    background: #22c55e;
    margin-right: 6px;
    animation: pulse 2s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 0.4; }
    50% { opacity: 1; }
  }
  /* ‚îÄ‚îÄ Guide Modal ‚îÄ‚îÄ */
  .guide-section {
    padding: 12px 0;
    border-bottom: 1px solid #1e1e22;
  }
  .guide-section:last-child { border-bottom: none; }
  .guide-heading {
    font-size: 13px;
    font-weight: 600;
    color: #e4e4e7;
    margin-bottom: 6px;
  }
  .guide-body {
    font-size: 12px;
    color: #71717a;
    line-height: 1.6;
  }

  /* ‚îÄ‚îÄ Guidance ‚îÄ‚îÄ */
  .guidance {
    padding: 0;
    background: transparent;
  }
  .guidance-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
  }
  .guidance-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
  }
  .guidance-dot.green { background: #22c55e; }
  .guidance-dot.yellow { background: #eab308; }
  .guidance-dot.orange { background: #f97316; }
  .guidance-dot.red { background: #ef4444; }
  .guidance-title {
    font-size: 12px;
    font-weight: 600;
    color: #71717a;
  }
  .guidance-tip {
    font-size: 12px;
    color: #52525b;
    line-height: 1.5;
    padding: 4px 0 4px 16px;
    position: relative;
  }
  .guidance-tip::before {
    content: '¬∑';
    position: absolute;
    left: 4px;
    color: #3f3f46;
  }

  /* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
  .panel-btn-primary {
    font-family: 'DM Sans', system-ui, sans-serif;
    font-size: 13px;
    font-weight: 500;
    color: #a1a1aa;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 12px 0;
    background: #18181b;
    border: 1px solid #27272a;
    border-radius: 8px;
    transition: color 0.2s, border-color 0.2s, background 0.2s;
    width: 100%;
  }
  .panel-btn-primary:hover { color: #e4e4e7; border-color: #3f3f46; background: #1e1e22; }

  .panel-btn {
    font-family: 'DM Sans', system-ui, sans-serif;
    font-size: 11px;
    color: #3f3f46;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 8px 0;
    background: transparent;
    border: none;
    border-radius: 6px;
    transition: color 0.2s;
    width: 100%;
  }
  .panel-btn:hover { color: #71717a; }

  .secondary-btns {
    display: flex;
    gap: 8px;
  }

  .modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }
  .modal-overlay.open {
    opacity: 1;
    pointer-events: auto;
  }
  .modal {
    background: #111113;
    border: 1px solid #1e1e22;
    border-radius: 14px;
    padding: 24px;
    width: 100%;
    max-width: 400px;
    max-height: 80vh;
    overflow-y: auto;
  }
  .modal-close {
    background: none;
    border: none;
    color: #52525b;
    font-size: 18px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
    transition: color 0.2s;
  }
  .modal-close:hover { color: #a1a1aa; }

  .error {
    color: #ef4444;
    font-size: 13px;
    text-align: center;
    padding: 32px;
  }
</style>
</head>
<body>

<div class="modal-overlay" id="handoff-modal" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="modal" style="max-width:520px">
    <div class="card-header">
      <span class="card-title">HANDOFF.md</span>
      <button class="modal-close" onclick="document.getElementById('handoff-modal').classList.remove('open')">‚úï</button>
    </div>
    <pre id="handoff-content" style="font-family:'JetBrains Mono',monospace;font-size:12px;color:#a1a1aa;line-height:1.6;white-space:pre-wrap;word-wrap:break-word;margin:0"></pre>
    <div id="handoff-meta" style="margin-top:12px;font-size:10px;color:#3f3f46"></div>
  </div>
</div>

<div class="modal-overlay" id="boot-modal" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="modal" id="boot-modal-body"></div>
</div>

<div class="modal-overlay" id="guide-modal" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="modal" style="max-width:500px">
    <div class="card-header">
      <span class="card-title">Session Management</span>
      <button class="modal-close" onclick="document.getElementById('guide-modal').classList.remove('open')">‚úï</button>
    </div>

    <div class="guide-section">
      <div class="guide-heading">The context window is a shared workspace</div>
      <div class="guide-body">Everything that happens in a session ‚Äî messages, file reads, tool outputs ‚Äî accumulates in the context window. It never shrinks. When it fills up, the agent's reasoning quality degrades.</div>
    </div>

    <div class="guide-section">
      <div class="guide-heading">Fewer topics, better work</div>
      <div class="guide-body">Each new topic adds context that competes for the agent's attention. Sessions focused on 1‚Äì2 related topics produce significantly better results than sessions that cover 5+ unrelated things. When you finish a topic, wrap and start fresh.</div>
    </div>

    <div class="guide-section">
      <div class="guide-heading">What the zones mean</div>
      <div class="guide-body">
        <span style="color:#22c55e">‚óè Under 25%</span> ‚Äî Full performance. No restrictions.<br>
        <span style="color:#eab308">‚óè 25‚Äì40%</span> ‚Äî Be intentional. Ask for summaries instead of full outputs.<br>
        <span style="color:#f97316">‚óè 40‚Äì50%</span> ‚Äî Degradation zone. Finish your current topic and wrap.<br>
        <span style="color:#ef4444">‚óè Over 50%</span> ‚Äî Wrap now. Complex reasoning is unreliable.
      </div>
    </div>

    <div class="guide-section">
      <div class="guide-heading">How to wrap</div>
      <div class="guide-body">Say <strong>"wrap session"</strong> when you're done or when the bar is getting full. The agent saves everything important ‚Äî current work, decisions, outcomes, next steps ‚Äî and carries it into the next session automatically. Nothing is lost.</div>
    </div>

    <div class="guide-section">
      <div class="guide-heading">Signs of degradation</div>
      <div class="guide-body">If the agent starts repeating itself, forgets earlier decisions, or ignores context from earlier in the conversation ‚Äî the context is degrading. These are signals to wrap, even if the bar isn't full yet.</div>
    </div>

    <div class="guide-section">
      <div class="guide-heading">Wrapping is free</div>
      <div class="guide-body">Starting a new session doesn't lose progress. The handoff file bridges sessions so the next one picks up exactly where this one left off. Frequent short sessions produce better work than one long marathon.</div>
    </div>
  </div>
</div>

<div class="layout" id="dashboard">
  <div class="card"><div class="error">Loading...</div></div>
</div>
<div class="footer" id="footer"></div>

<script>
function fmt(n) {
  if (n >= 1000000) return (n/1000000).toFixed(1) + 'M';
  if (n >= 1000) return Math.round(n/1000) + 'K';
  return n + '';
}
function fmtBytes(n) {
  if (n >= 1024) return (n/1024).toFixed(1) + 'KB';
  return n + 'B';
}
function zone(pct) {
  if (pct >= 0.50) return 'red';
  if (pct >= 0.40) return 'orange';
  if (pct >= 0.25) return 'yellow';
  return 'green';
}
function zoneLabel(pct) {
  if (pct >= 0.50) return 'WRAP';
  if (pct >= 0.40) return 'DEGRADE';
  if (pct >= 0.25) return 'CAUTION';
  return 'HEALTHY';
}
function elapsed(isoStr) {
  if (!isoStr) return '‚Äî';
  const ms = Date.now() - new Date(isoStr).getTime();
  const min = Math.floor(ms / 60000);
  if (min < 60) return min + 'm';
  const hr = Math.floor(min / 60);
  return hr + 'h ' + (min % 60) + 'm';
}

function getGuidance(pct, topicCount) {
  if (pct >= 0.50) return {
    zone: 'red',
    title: 'Wrap zone',
    tips: [
      'Quality is degrading ‚Äî the agent may repeat itself or miss earlier context',
      'Say "wrap session" to save progress and start fresh',
      'Everything important gets carried into the next session automatically'
    ]
  };
  if (pct >= 0.40) return {
    zone: 'orange',
    title: 'Finish up',
    tips: [
      'Complex reasoning starts to degrade around this point',
      'Finish your current topic, then wrap ‚Äî don\'t start new threads',
      'The agent should be warning you and preparing to wrap'
    ]
  };
  if (pct >= 0.25) return {
    zone: 'yellow',
    title: 'Be intentional',
    tips: [
      'Every file read and tool output stays in context for the rest of the session',
      'Ask the agent to summarize large outputs instead of showing everything',
      topicCount >= 3 ? `${topicCount} topics so far ‚Äî focused sessions (1-2 topics) produce better results` : 'Keep the session focused on 1-2 related topics for best results'
    ]
  };
  return {
    zone: 'green',
    title: 'Session health',
    tips: [
      'Context is a shared workspace ‚Äî what loads in stays in',
      'Fewer topics per session = better quality work on each one',
      'When you\'re done with a task, wrapping gives the next session a clean start'
    ]
  };
}

function getNudge(pct, velocity, minutesToWrap, live) {
  const topicCount = live ? (live.topics || []).length : 0;
  let msg = '';
  let color = '#3f3f46';

  // Priority: most urgent first
  if (pct >= 0.50) {
    msg = 'üî¥ Context is full ‚Äî wrap session now to preserve quality';
    color = '#ef4444';
  } else if (pct >= 0.40) {
    msg = 'üü† Degradation zone ‚Äî finish current topic and wrap';
    color = '#f97316';
  } else if (minutesToWrap && minutesToWrap < 20) {
    msg = '‚ö° Context growing fast ‚Äî ~' + minutesToWrap + 'm to wrap zone';
    color = '#f97316';
  } else if (pct >= 0.25) {
    msg = 'üü° Past 25% ‚Äî be intentional about what you load';
    color = '#eab308';
  } else if (topicCount >= 5) {
    msg = 'üìã ' + topicCount + ' topics this session ‚Äî consider wrapping and starting fresh';
    color = '#eab308';
  } else if (topicCount >= 3) {
    msg = 'üìã ' + topicCount + ' topics ‚Äî focused sessions produce better results';
    color = '#52525b';
  } else if (velocity > 5000) {
    msg = '‚ö° Heavy output ‚Äî large tool results consuming context quickly';
    color = '#52525b';
  } else {
    return '';
  }

  return `<div style="margin-top:12px;padding:8px 10px;background:#18181b;border-radius:6px;font-size:11px;color:${color};line-height:1.4">${msg}</div>`;
}

async function openHandoff() {
  try {
    // Fetch both context (for scratch) and handoff
    const [ctxRes, hRes] = await Promise.all([
      fetch('/api/context'),
      fetch('/api/handoff')
    ]);
    const ctx = await ctxRes.json();
    const h = await hRes.json();

    const scratch = ctx.handoffScratch;
    const el = document.getElementById('handoff-content');
    const meta = document.getElementById('handoff-meta');

    if (scratch && scratch.content) {
      // Show live scratch file
      el.textContent = scratch.content;
      meta.innerHTML = '<span style="color:#22c55e">‚óè LIVE</span> ‚Äî Updated ' + new Date(scratch.mtime).toLocaleString();
    } else if (h.content) {
      // Fall back to HANDOFF.md
      el.textContent = h.content;
      meta.textContent = h.mtime ? 'From last session ‚Äî ' + new Date(h.mtime).toLocaleString() : '';
    } else {
      el.textContent = 'No handoff data available.';
      meta.textContent = '';
    }

    document.getElementById('handoff-modal').classList.add('open');
  } catch(e) {
    document.getElementById('handoff-content').textContent = 'Failed to load: ' + e.message;
    document.getElementById('handoff-modal').classList.add('open');
  }
}

async function refresh() {
  try {
    const r = await fetch('/api/context');
    const d = await r.json();
    if (d.error) throw new Error(d.error);
    if (!d.contextUsed && d.contextUsed !== 0) throw new Error('No context data');

    const used = d.contextUsed;
    const win = d.contextWindow;
    const pct = used / win;
    const z = zone(pct);
    const live = d.live;
    const stats = d.stats;
    const h = d.handoff;
    const b = d.boot;

    // ‚îÄ‚îÄ Session Feed ‚îÄ‚îÄ
    let left = `
      <div class="card">
        <div class="card-header">
          <span class="card-title">Current session</span>
          <span class="mono" style="font-size:11px;color:${live && live.topics && live.topics.length >= 5 ? '#eab308' : live && live.topics && live.topics.length >= 3 ? '#52525b' : '#3f3f46'}">${live && live.topics ? live.topics.length + ' topic' + (live.topics.length !== 1 ? 's' : '') : elapsed(d.sessionStart)}</span>
        </div>`;

    if (live) {
      left += `
        <div class="card-title" style="margin-bottom:6px">Main focus</div>
        ${live.focus
          ? `<div class="focus-block">${live.focus}</div>`
          : `<div class="focus-block" style="color:#52525b;border-color:#1e1e22">No focus set ‚Äî tell your agent what you're working on to keep the session anchored.</div>`
        }`;

      if (live.topics && live.topics.length) {
        left += `<div class="feed-section">
          <div class="card-title" style="margin-top:16px;margin-bottom:8px">Topics covered</div>
          <div class="feed-list">
            ${live.topics.map(t => `<div class="feed-item topic">${t}</div>`).join('')}
          </div>
        </div>`;
      }

      if (live.decisions && live.decisions.length) {
        left += `<div class="feed-section">
          <div class="card-title" style="margin-top:16px;margin-bottom:8px">Decisions</div>
          <div class="feed-list">
            ${live.decisions.map(t => `<div class="feed-item decision">${t}</div>`).join('')}
          </div>
        </div>`;
      }

      if (live.outcomes && live.outcomes.length) {
        left += `<div class="feed-section">
          <div class="card-title" style="margin-top:16px;margin-bottom:8px">Outcomes</div>
          <div class="feed-list">
            ${live.outcomes.map(t => `<div class="feed-item outcome">${t}</div>`).join('')}
          </div>
        </div>`;
      }

      left += `<div class="feed-footer">Updated ${new Date(live.updatedAt).toLocaleTimeString()}</div>`;
    } else if (stats) {
      // No live session file ‚Äî show derived stats from JSONL
      left += `
        <div class="focus-block" style="color:#52525b;border-color:#1e1e22">Session tracking will update as conversation progresses.</div>
        <div class="feed-section">
          <div class="card-title" style="margin-top:16px;margin-bottom:8px">Session activity</div>
          <div class="feed-list">
            <div class="feed-item topic">${stats.userMessages} user message${stats.userMessages !== 1 ? 's' : ''}, ${stats.assistantMessages} assistant response${stats.assistantMessages !== 1 ? 's' : ''}</div>
            ${stats.toolCalls ? `<div class="feed-item topic">${stats.toolCalls} tool call${stats.toolCalls !== 1 ? 's' : ''}</div>` : ''}
            ${stats.lastActivity ? `<div class="feed-item topic">Last activity ${new Date(stats.lastActivity).toLocaleTimeString()}</div>` : ''}
          </div>
        </div>`;
    } else if (h && h.currentWork) {
      left += `<div class="focus-block">${h.currentWork}</div>`;
    } else {
      left += `<div style="color:#3f3f46;font-size:13px">No active session data</div>`;
    }

    left += `</div>`;

    // ‚îÄ‚îÄ Metrics ‚îÄ‚îÄ
    let right = ``;

    // Context + info card
    right += `
      <div class="card">
        <div class="card-header">
          <span class="card-title">Context window</span>
          <span class="zone-badge ${z}">${zoneLabel(pct)}</span>
        </div>
        <div class="big-pct ${z}">${(pct * 100).toFixed(1)}%</div>
        <div class="context-sub">${fmt(used)} / ${fmt(win)}</div>
        <div class="bar-track">
          <div class="bar-fill ${z}" style="width:${Math.min((pct/0.5)*100,100)}%"></div>
          <div class="zone-markers">
            <div class="zone-mark" style="left:50%"><span class="zone-mark-label">25%</span></div>
            <div class="zone-mark" style="left:80%"><span class="zone-mark-label">40%</span></div>
            <div class="zone-mark" style="left:100%"><span class="zone-mark-label">50%</span></div>
          </div>
        </div>
        <div class="zone-legend">
          <div class="zone-legend-item"><div class="zone-dot green"></div>&lt;25% Healthy</div>
          <div class="zone-legend-item"><div class="zone-dot yellow"></div>25-40%</div>
          <div class="zone-legend-item"><div class="zone-dot orange"></div>40-50%</div>
          <div class="zone-legend-item"><div class="zone-dot red"></div>&gt;50% Wrap</div>
        </div>
        <div style="margin-top:16px;padding-top:12px;border-top:1px solid #1e1e22">
          <div class="meta-row">
            <span class="meta-label">Model</span>
            <span class="meta-value">${d.model.split('/').pop()}</span>
          </div>
          <div class="meta-row">
            <span class="meta-label">Duration</span>
            <span class="meta-value">${elapsed(d.sessionStart)}</span>
          </div>
        </div>
        ${getNudge(pct, d.velocity, d.minutesToWrap, live)}
      </div>`;

    // Buttons
    right += `<div class="panel-btn-primary" onclick="document.getElementById('guide-modal').classList.add('open')">
      Session management tips
    </div>`;

    right += `<div class="secondary-btns">
      <div class="panel-btn" onclick="openHandoff()">HANDOFF.md</div>
      <div class="panel-btn" style="color:#3f3f46">¬∑</div>
    `;

    // Boot link
    if (b) {
      const hasIssues = b.files.some(f => f.over) || b.total > 12000;
      right += `<div class="panel-btn" onclick="document.getElementById('boot-modal').classList.add('open')">
        Session startup
      </div></div>`;

      // Build modal content (updated each refresh)
      const fileDescriptions = {
        'AGENTS.md': 'Behavioral rules and skill triggers. Loads every API turn ‚Äî the most expensive file.',
        'SOUL.md': 'Agent personality and voice. Sets tone for all responses.',
        'USER.md': 'Information about you ‚Äî name, preferences, work style.',
        'MEMORY.md': 'Current priorities, active projects, key people. The big picture briefing.',
        'HANDOFF.md': 'What happened last session ‚Äî outcomes, next steps. The session bridge.',
        'IDENTITY.md': 'Agent identity ‚Äî accounts, infrastructure, channels.'
      };
      document.getElementById('boot-modal-body').innerHTML = `
        <div class="card-header">
          <span class="card-title">Session Startup</span>
          <button class="modal-close" onclick="document.getElementById('boot-modal').classList.remove('open')">‚úï</button>
        </div>

        <div class="guide-section">
          <div class="guide-heading">What loads before your first message</div>
          <div class="guide-body">Every session begins by loading workspace files into the context window. These files shape how the agent behaves, what it knows about you, and where it left off. The total cost is ~${fmt(Math.round(b.total / 4))} tokens before you say anything.</div>
        </div>

        <div class="guide-section">
          <div class="guide-heading">Workspace files</div>
          <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
            ${b.files.map(f => `
              <div>
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <span style="font-size:12px;font-weight:600;color:#e4e4e7">${f.name}</span>
                  <span class="boot-size ${f.over ? 'over' : 'ok'}" style="font-size:11px">${fmtBytes(f.size)}${f.limit ? ' / ' + fmtBytes(f.limit) : ''}</span>
                </div>
                <div style="font-size:11px;color:#52525b;margin-top:2px">${fileDescriptions[f.name] || ''}</div>
              </div>
            `).join('')}
          </div>
        </div>

        <div class="guide-section">
          <div class="guide-heading">Skills</div>
          <div class="guide-body">${b.skills} skills registered. Each skill listing costs ~75 tokens in the system prompt whether it's used or not. The agent loads a skill's full instructions only when it's triggered.</div>
        </div>

        <div class="guide-section">
          <div class="guide-heading">Memory files</div>
          <div class="guide-body">${b.memoryFiles} files in memory/ (${fmtBytes(b.memorySize)} total). These don't auto-load ‚Äî the agent searches them on demand when it needs past context.</div>
        </div>

        <div class="guide-section">
          <div class="guide-heading">Why size matters</div>
          <div class="guide-body">Workspace files load into every session. AGENTS.md loads on every single API call ‚Äî not just session start. A 6KB AGENTS.md when 4KB would do costs an extra 500 tokens on every message you send. Over a session, that adds up fast.</div>
        </div>

        <div style="margin-top:12px;padding-top:12px;border-top:1px solid #1e1e22;display:flex;justify-content:space-between">
          <div class="boot-total-item">
            <div class="boot-total-value">${fmtBytes(b.total)}</div>
            <div class="boot-total-label">Total size</div>
          </div>
          <div class="boot-total-item">
            <div class="boot-total-value">~${fmt(Math.round(b.total / 4))}</div>
            <div class="boot-total-label">Tokens</div>
          </div>
          <div class="boot-total-item">
            <div class="boot-total-value">${b.skills}</div>
            <div class="boot-total-label">Skills</div>
          </div>
          <div class="boot-total-item">
            <div class="boot-total-value">${b.memoryFiles}</div>
            <div class="boot-total-label">Memory files</div>
          </div>
        </div>
      `;

    }

    right += ``;

    document.getElementById('dashboard').innerHTML = `<div class="col">${right}</div><div class="col">${left}</div>`;
    document.getElementById('footer').innerHTML =
      `<span class="pulse"></span>Auto-refresh 10s ¬∑ ${new Date().toLocaleTimeString()}<br><span style="color:#3f3f46;margin-top:8px;display:inline-block">Built by Sigma Labs</span>`;

  } catch(e) {
    document.getElementById('dashboard').innerHTML = `<div class="card"><div class="error">${e.message}</div></div>`;
  }
}

refresh();
setInterval(refresh, 10000);
</script>
</body>
</html>
